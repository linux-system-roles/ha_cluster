# SPDX-License-Identifier: MIT
---
- name: Test qdevice - tls and KAPTB options
  hosts: all
  vars_files: vars/main.yml
  vars:
    _required_capability: corosync.quorum.device.model.net.options_tls_and_kaptb

  tasks:
    - name: Set qnetd address
      set_fact:
        __test_qnetd_address: "{{
            (ansible_play_hosts_all | length == 1)
            | ternary('localhost', ansible_play_hosts[0]) }}"

    - name: Ensure correct package manager for ostree systems
      vars:
        ostree_pkg_mgr: ansible.posix.rhel_rpm_ostree
        ostree_booted_file: /run/ostree-booted
      when: ansible_facts.pkg_mgr | d("") != ostree_pkg_mgr
      block:
        - name: Check if system is ostree
          stat:
            path: "{{ ostree_booted_file }}"
          register: __ostree_booted_stat

        - name: Set package manager to use for ostree
          ansible.utils.update_fact:
            updates:
              - path: ansible_facts.pkg_mgr
                value: "{{ ostree_pkg_mgr }}"
          when: __ostree_booted_stat.stat.exists

    # Install pcs so we can detect whether it supports tls and kaptb options
    - name: Install pcs
      package:
        name: pcs
        state: present

    - name: Fetch versions of cluster components
      include_tasks: tasks/fetch_versions.yml

    - name: Run test
      tags: tests::verify
      include_tasks: template_qdevice.yml
      when:
        - _required_capability in __test_pcs_capabilities
      vars:
        ha_cluster_quorum:
          device:
            model: net
            model_options:
              - name: host
                value: "{{ __test_qnetd_address }}"
              - name: algorithm
                value: lms
              - name: tls
                value: required
              - name: keep_active_partition_tie_breaker
                value: "on"
        __test_expected_lines:
          - "totem {"
          - "    version: 2"
          - "    cluster_name: {{ ha_cluster_cluster_name }}"
          - "    transport: knet"
          - "    crypto_cipher: aes256"
          - "    crypto_hash: sha256"
          - "}"
          - "nodelist {"
          - "}"
          - "quorum {"
          - "    provider: corosync_votequorum"
          - "    device {"
          - "        model: net"
          - "        net {"
          - "            algorithm: lms"
          - "            host: {{ __test_qnetd_address }}"
          - "            keep_active_partition_tie_breaker: on"
          - "            tls: required"
          - "        }"
          - "    }"
          - "}"
          - "logging {"
          - "    to_logfile: yes"
          - "    logfile: /var/log/cluster/corosync.log"
          - "    to_syslog: yes"
          - "    timestamp: on"
          - "}"

    - name: Warn about skipped test
      debug:
        msg: This test needs pcs with {{ _required_capability }} capability
      when:
        - _required_capability not in __test_pcs_capabilities
